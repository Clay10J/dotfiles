#!/usr/bin/env bash
set -e

# Only run on Linux hosts
if [ "$(uname -s)" != "Linux" ]; then
  exit 0
fi

# 1) Install Kitty via the official binary installer if missing
if ! command -v kitty >/dev/null 2>&1; then
  echo "ðŸ”½ Installing Kitty via official installer"
  curl -L https://sw.kovidgoyal.net/kitty/installer.sh \
    | sh /dev/stdin

  # Symlink kitty and kitten into ~/.local/bin
  mkdir -p "$HOME/.local/bin"
  ln -sf "$HOME/.local/kitty.app/bin/kitty" "$HOME/.local/bin/kitty"
  ln -sf "$HOME/.local/kitty.app/bin/kitten" "$HOME/.local/bin/kitten"
fi

# 2) Desktop integration so Kitty appears in your application menu
echo "ðŸ“‚ Setting up desktop entries for Kitty"

APPLICATIONS_DIR="$HOME/.local/share/applications"
mkdir -p "$APPLICATIONS_DIR"

# Copy all .desktop files from the Kitty install
for desktop in "$HOME/.local/kitty.app/share/applications/"*.desktop; do
  cp "$desktop" "$APPLICATIONS_DIR/"
done

# Update Exec and Icon paths in those desktop files
ICON_PATH="$HOME/.local/kitty.app/share/icons/hicolor/256x256/apps/kitty.png"
EXEC_PATH="$HOME/.local/kitty.app/bin/kitty"
for desktop in "$APPLICATIONS_DIR"/kitty*.desktop; do
  sed -i \
    -e "s|^Exec=kitty|Exec=$EXEC_PATH|g" \
    -e "s|^Icon=kitty|Icon=$ICON_PATH|g" \
    "$desktop"
done

# 3) Register Kitty as a terminal for xdg-open
mkdir -p "$HOME/.config"
echo 'kitty.desktop' > "$HOME/.config/xdg-terminals.list"
