{{- if eq .chezmoi.os "linux" -}}
#!/usr/bin/env bash
set -e

DATA_DIR="$HOME/.local/share/chezmoi/.chezmoidata"
PKG_FILE="$DATA_DIR/packages.yaml"

# Load CLI packages
cli_pkgs=$(yq e '.packages.linux.cli[]' "$PKG_FILE")
pkgs="$cli_pkgs"

# 5.2 Host-specific GUI packages (skip on headless)
{{- $host := index .data .chezmoi.hostname -}}
{{- if not $host.headless -}}
gui_pkgs=$(yq e '.packages.linux.gui[]' "$PKG_FILE")
pkgs="$pkgs $gui_pkgs"
{{- end -}}

# 5.4 Install loop (only runs on Linux via the guard above)
sudo apt-get update
for pkg in $pkgs; do
  if ! dpkg -s "$pkg" >/dev/null 2>&1; then
    sudo apt-get install -y "$pkg"
  fi
done

# ─── ensure fd → fdfind ────────────────────────────────
if command -v fdfind >/dev/null 2>&1; then
  mkdir -p "$HOME/.local/bin"
  ln -sf "$(command -v fdfind)" "$HOME/.local/bin/fd"
fi
{{- end -}}
