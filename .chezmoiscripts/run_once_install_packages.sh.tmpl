#!/usr/bin/env bash
set -euo pipefail

# This script installs all packages defined in packages.yaml
# It's a 'run_once' script because packages only need to be installed once

# —————— COLORS & LOGGING ——————
BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'
log_info() { echo -e "\n${BLUE}ℹ️  $1${NC}"; }
log_success() { echo -e "${GREEN}✅ $1${NC}"; }
log_warning() { echo -e "${YELLOW}⚠️  $1${NC}"; }
log_error() { echo -e "${RED}❌ $1${NC}"; }

# —————— PACKAGE LISTS (from chezmoi template) ——————
{{ if eq .chezmoi.kernel.osrelease "debian" }}
# Debian/Ubuntu packages
CORE_PACKAGES=(
{{ range .core.common }}
    "{{ . }}"
{{ end }}
{{ range .core.debian }}
    "{{ . }}"
{{ end }}
)

{{ if not .headless }}
GUI_PACKAGES=(
{{ range .gui.common }}
    "{{ . }}"
{{ end }}
{{ range .gui.debian }}
    "{{ . }}"
{{ end }}
)
{{ end }}

# —————— REPOSITORY CONFIGURATION ——————
{{ range .repositories }}
# {{ .name }}
REPO_{{ .name | replace " " "_" | upper }}_KEY_URL="{{ .key_url }}"
REPO_{{ .name | replace " " "_" | upper }}_REPO_URL="{{ .repo_url }}"
REPO_{{ .name | replace " " "_" | upper }}_KEYRING_PATH="{{ .keyring_path }}"
REPO_{{ .name | replace " " "_" | upper }}_LIST_PATH="{{ .list_path }}"
{{ end }}

{{ else if eq .chezmoi.kernel.osrelease "arch" }}
# Arch Linux packages
CORE_PACKAGES=(
{{ range .core.common }}
    "{{ . }}"
{{ end }}
{{ range .core.arch }}
    "{{ . }}"
{{ end }}
)

{{ if not .headless }}
GUI_PACKAGES=(
{{ range .gui.common }}
    "{{ . }}"
{{ end }}
{{ range .gui.arch }}
    "{{ . }}"
{{ end }}
)
{{ end }}

# AUR packages (optional)
AUR_PACKAGES=(
{{ range .aur }}
    "{{ . }}"
{{ end }}
)
{{ end }}

# —————— SCRIPT LOGIC ——————
main() {
    log_info "Installing packages..."

{{ if eq .chezmoi.kernel.osrelease "debian" }}
    # Debian/Ubuntu installation
    log_info "Detected Debian/Ubuntu system, using apt..."

    # Add repositories first
    log_info "Adding external repositories..."
{{ range .repositories }}
    log_info "Adding repository: {{ .name }}"
    # Import GPG key with better error handling
    if [[ "{{ .key_url }}" == *".gpg" ]]; then
        # Key is already in .gpg format, download directly
        if ! curl -sS "{{ .key_url }}" | sudo tee "{{ .keyring_path }}" > /dev/null; then
            log_error "Failed to download GPG key for {{ .name }}"
            continue
        fi
    else
        # Key is in .asc format, need to dearmor
        if ! curl -sS "{{ .key_url }}" | sudo gpg --dearmor --yes --output "{{ .keyring_path }}" 2>/dev/null; then
            log_warning "Failed to import GPG key for {{ .name }}, trying alternative method..."
            # Alternative: download key and import directly
            curl -sS "{{ .key_url }}" | sudo apt-key add - 2>/dev/null || {
                log_error "Failed to import GPG key for {{ .name }}"
                continue
            }
        fi
    fi
    echo "{{ .repo_url }}" | sudo tee "{{ .list_path }}" > /dev/null
{{ end }}

    # Update package lists
    log_info "Updating package lists..."
    sudo apt-get update -qq

    # Install core packages
    if [[ ${#CORE_PACKAGES[@]} -gt 0 ]]; then
        log_info "Installing core packages..."
        sudo apt-get install -y -qq "${CORE_PACKAGES[@]}"
        log_success "Core packages installed: ${CORE_PACKAGES[*]}"
    fi

    # Install GUI packages (only if not headless)
{{ if not .headless }}
    if [[ ${#GUI_PACKAGES[@]} -gt 0 ]]; then
        log_info "Installing GUI packages..."
        sudo apt-get install -y -qq "${GUI_PACKAGES[@]}"
        log_success "GUI packages installed: ${GUI_PACKAGES[*]}"
    fi
{{ else }}
    log_info "Skipping GUI packages (headless machine)"
{{ end }}

{{ else if eq .chezmoi.kernel.osrelease "arch" }}
    # Arch Linux installation
    log_info "Detected Arch Linux system, using pacman..."

    # Update package database
    log_info "Updating package database..."
    sudo pacman -Sy --noconfirm

    # Install core packages
    if [[ ${#CORE_PACKAGES[@]} -gt 0 ]]; then
        log_info "Installing core packages..."
        sudo pacman -S --noconfirm "${CORE_PACKAGES[@]}"
        log_success "Core packages installed: ${CORE_PACKAGES[*]}"
    fi

    # Install GUI packages (only if not headless)
{{ if not .headless }}
    if [[ ${#GUI_PACKAGES[@]} -gt 0 ]]; then
        log_info "Installing GUI packages..."
        # Install 1Password and Brave Browser from AUR if available
        for package in "${GUI_PACKAGES[@]}"; do
            case "$package" in
                "1password")
                    log_info "Installing 1Password desktop app..."
                    if command -v paru >/dev/null 2>&1; then
                        paru -S --noconfirm 1password
                    elif command -v yay >/dev/null 2>&1; then
                        yay -S --noconfirm 1password
                    else
                        log_warning "No AUR helper found, skipping 1Password desktop app"
                    fi
                    ;;
                "brave-browser")
                    log_info "Installing Brave Browser..."
                    if command -v paru >/dev/null 2>&1; then
                        paru -S --noconfirm brave-browser
                    elif command -v yay >/dev/null 2>&1; then
                        yay -S --noconfirm brave-browser
                    else
                        log_warning "No AUR helper found, skipping Brave Browser"
                    fi
                    ;;
                *)
                    # Install other packages with pacman
                    sudo pacman -S --noconfirm "$package"
                    ;;
            esac
        done
        log_success "GUI packages installed"
    fi
{{ else }}
    log_info "Skipping GUI packages (headless machine)"
{{ end }}

    # Install AUR packages if any (requires paru or yay)
    if [[ ${#AUR_PACKAGES[@]} -gt 0 ]]; then
        log_info "Installing AUR packages..."
        if command -v paru >/dev/null 2>&1; then
            paru -S --noconfirm "${AUR_PACKAGES[@]}"
            log_success "AUR packages installed: ${AUR_PACKAGES[*]}"
        elif command -v yay >/dev/null 2>&1; then
            yay -S --noconfirm "${AUR_PACKAGES[@]}"
            log_success "AUR packages installed: ${AUR_PACKAGES[*]}"
        else
            log_warning "No AUR helper (paru/yay) found, skipping AUR packages"
        fi
    fi

{{ else }}
    log_error "Unsupported operating system: {{ .chezmoi.kernel.osrelease }}"
    exit 1
{{ end }}

    log_success "All packages installed successfully!"
}

main "$@" 